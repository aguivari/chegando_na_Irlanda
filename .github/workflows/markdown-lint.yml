name: Lint Markdown Files

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14

    - name: Install dependencies
      run: npm ci

    - name: Lint markdown files
      run: |
        npx markdownlint --config .markdownlint.json "**/*.md"
        if [ $? -ne 0 ]; then
          echo "::error::Markdown linting failed"
          exit 1
        fi

    - name: Report linting results
      id: results
      uses: actions/upload-artifact@v2
      with:
        name: lint-report.json
        path: markdownlint_result.json

    - name: Comment on pull request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v2
      with:
        script: |
          const lintErrors = steps.lint.outputs.stderr;
          const lintResultsLink = steps.results.outputs.artifact_url;
          const pullRequestNumber = github.event.number;

          const commentBody = `
          ## Markdown Lint Results
          ${lintResultsLink}
          ## Lint Errors
          ${lintErrors}
          `;

          const response = await github.pulls.createReview({
            owner: github.repository.owner.login,
            repo: github.repository.name,
            pull_number: pullRequestNumber,
            body: commentBody,
            event: "COMMENT"
          });

          console.log(response.data);
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
